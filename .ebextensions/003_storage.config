commands:
  01_create_storage_dirs:
    command: |
      mkdir -p /var/app/staging/storage/app/private
      mkdir -p /var/app/staging/storage/framework/cache
      mkdir -p /var/app/staging/storage/framework/sessions
      mkdir -p /var/app/staging/storage/framework/views
      mkdir -p /var/app/staging/storage/logs
    ignoreErrors: true

container_commands:
  08_fix_storage_permissions:
    command: |
      # Create storage directories if they don't exist
      mkdir -p /var/app/staging/storage/app/private/jform-production-filesystem
      mkdir -p /var/app/staging/storage/framework/cache/data
      mkdir -p /var/app/staging/storage/framework/sessions
      mkdir -p /var/app/staging/storage/framework/views
      mkdir -p /var/app/staging/storage/logs
      
      # Set proper ownership and permissions
      chown -R webapp:webapp /var/app/staging/storage
      chown -R webapp:webapp /var/app/staging/bootstrap/cache
      chmod -R 775 /var/app/staging/storage
      chmod -R 775 /var/app/staging/bootstrap/cache
      
      # Ensure web server can write to these directories
      find /var/app/staging/storage -type d -exec chmod 775 {} \;
      find /var/app/staging/storage -type f -exec chmod 664 {} \;
    cwd: "/var/app/staging"