container_commands:
  01_create_env_file:
    command: |
      #!/bin/bash
      set -e  # Exit on any error

      # Function to log messages
      log_message() {
          echo "[ENV-SETUP] $1" | tee -a /var/log/eb-activity.log
      }

      log_message "Starting environment file creation..."

      # Determine the correct application path
      if [ -d "/var/app/staging" ]; then
          APP_PATH="/var/app/staging"
          log_message "Using staging path: $APP_PATH"
      elif [ -d "/var/app/current" ]; then
          APP_PATH="/var/app/current"
          log_message "Using current path: $APP_PATH"
      else
          log_message "ERROR: Could not find application directory"
          exit 0  # Don't fail deployment, just skip
      fi

      # Check if get-config command exists
      if [ ! -f "/opt/elasticbeanstalk/bin/get-config" ]; then
          log_message "WARNING: get-config command not found, skipping env file creation"
          exit 0
      fi

      # Create temporary file with proper permissions
      TEMP_ENV_FILE="/tmp/eb_env_$$.json"

      # Get environment variables with error handling
      if ! /opt/elasticbeanstalk/bin/get-config environment > "$TEMP_ENV_FILE" 2>/dev/null; then
          log_message "WARNING: Could not retrieve environment variables"
          rm -f "$TEMP_ENV_FILE"
          exit 0
      fi

      # Check if PHP is available
      if ! command -v php >/dev/null 2>&1; then
          log_message "WARNING: PHP not available, skipping env file creation"
          rm -f "$TEMP_ENV_FILE"
          exit 0
      fi

      # Validate JSON content
      if ! php -r "json_decode(file_get_contents('$TEMP_ENV_FILE'));" 2>/dev/null; then
          log_message "WARNING: Invalid JSON in environment config"
          rm -f "$TEMP_ENV_FILE"
          exit 0
      fi

      # Create .env file with comprehensive error handling
      php -r "
      try {
          \$jsonContent = file_get_contents('$TEMP_ENV_FILE');
          if (\$jsonContent === false) {
              throw new Exception('Could not read temp file');
          }

          \$envVars = json_decode(\$jsonContent, true);
          if (json_last_error() !== JSON_ERROR_NONE) {
              throw new Exception('JSON decode error: ' . json_last_error_msg());
          }

          \$envContent = '';

          if (\$envVars && is_array(\$envVars)) {
              foreach (\$envVars as \$key => \$value) {
                  // Skip invalid keys
                  if (empty(\$key) || !is_string(\$key) || !preg_match('/^[A-Z_][A-Z0-9_]*$/', \$key)) {
                      continue;
                  }

                  // Handle different value types
                  if (\$value === null) {
                      \$value = '';
                  } elseif (is_bool(\$value)) {
                      \$value = \$value ? 'true' : 'false';
                  } elseif (is_numeric(\$value)) {
                      \$value = (string)\$value;
                  } else {
                      \$value = (string)\$value;
                  }

                  // Escape values that need it
                  if (strpos(\$value, ' ') !== false ||
                      strpos(\$value, '\"') !== false ||
                      strpos(\$value, \"'\") !== false ||
                      strpos(\$value, '#') !== false ||
                      strpos(\$value, '\n') !== false ||
                      strpos(\$value, '\r') !== false) {
                      \$value = '\"' . str_replace(['\"', '\n', '\r'], ['\\\"', '\\n', '\\r'], \$value) . '\"';
                  }

                  \$envContent .= \$key . '=' . \$value . PHP_EOL;
              }
          }

          // Only write if we have content and target directory exists
          if (!empty(\$envContent) && is_dir('$APP_PATH')) {
              \$envFilePath = '$APP_PATH/.env';
              if (file_put_contents(\$envFilePath, \$envContent) === false) {
                  throw new Exception('Could not write .env file');
              }
              echo 'SUCCESS: Created .env file with ' . count(\$envVars) . ' variables' . PHP_EOL;
          } else {
              echo 'INFO: No environment variables to process' . PHP_EOL;
          }

      } catch (Exception \$e) {
          echo 'ERROR: ' . \$e->getMessage() . PHP_EOL;
          exit(0); // Don't fail deployment
      }
      " 2>&1 | tee -a /var/log/eb-activity.log

      # Set proper permissions if .env file was created
      if [ -f "$APP_PATH/.env" ]; then
          chown webapp:webapp "$APP_PATH/.env" 2>/dev/null || true
          chmod 644 "$APP_PATH/.env" 2>/dev/null || true
          log_message "Set permissions for .env file"
      fi

      # Clean up
      rm -f "$TEMP_ENV_FILE"
      log_message "Environment file creation completed"
