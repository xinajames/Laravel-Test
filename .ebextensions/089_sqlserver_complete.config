commands:
  01_add_mssql_repo:
    command: |
      if [ ! -f /.added_mssql_repo ]; then
        curl -s https://packages.microsoft.com/config/rhel/9/prod.repo | sudo tee /etc/yum.repos.d/mssql-release.repo
        sudo touch /.added_mssql_repo
      fi
    test: test ! -f /.added_mssql_repo
    ignoreErrors: true

  02_install_odbc_driver:
    command: |
      if [ ! -f /.installed_mssql_odbc ]; then
        sudo ACCEPT_EULA=Y yum install -y msodbcsql17 unixODBC-devel
        sudo touch /.installed_mssql_odbc
      fi
    test: test ! -f /.installed_mssql_odbc

  03_install_build_tools:
    command: |
      if [ ! -f /.installed_build_tools ]; then
        sudo yum install -y php-devel gcc gcc-c++ make autoconf
        sudo touch /.installed_build_tools
      fi
    test: test ! -f /.installed_build_tools

  04_install_sqlsrv_extensions:
    command: |
      if [ ! -f /.installed_sqlsrv_ext ]; then
        sudo pecl install sqlsrv-5.11.1 pdo_sqlsrv-5.11.1
        sudo touch /.installed_sqlsrv_ext
      fi
    test: test ! -f /.installed_sqlsrv_ext
    ignoreErrors: true

files:
  "/etc/php.d/30-sqlsrv.ini":
    mode: "000644"
    owner: root
    group: root
    content: |
      ; Load extensions only if not already loaded
      extension=sqlsrv.so
      extension=pdo_sqlsrv.so

container_commands:
  01_restart_services:
    command: |
      sudo systemctl restart php-fpm
      sudo systemctl restart nginx
    ignoreErrors: true

  02_test_sqlserver_connection:
    command: |
      echo "Testing SQL Server PHP extensions..."
      php -r "
      if (extension_loaded('sqlsrv')) {
          echo 'sqlsrv extension loaded successfully\n';
      } else {
          echo 'ERROR: sqlsrv extension not loaded\n';
      }
      if (extension_loaded('pdo_sqlsrv')) {
          echo 'pdo_sqlsrv extension loaded successfully\n';
      } else {
          echo 'ERROR: pdo_sqlsrv extension not loaded\n';
      }
      "
    ignoreErrors: true